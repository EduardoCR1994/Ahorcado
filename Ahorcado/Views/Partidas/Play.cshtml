@model Ahorcado.Models.Partida
@{
    ViewBag.Title = "Partida - Jugar";
    var palabra = Model.Palabra.Texto;
    var jugador = Model.Jugador.Nombre;
    var nivel = Model.Nivel;
    var partidaId = Model.PartidaID;
}

<h2 class="text-center mb-4"><i class="fas fa-gamepad"></i> Ahorcado - ¡Buena Suerte!</h2>

<div class="card text-center p-4">
    <p><strong>🎮 Jugador:</strong> @jugador</p>
    <p><strong>🎯 Nivel:</strong> @nivel</p>

    <h3 id="palabra-oculta" class="display-5 mt-4" style="letter-spacing: 12px;"></h3>

    <div class="d-flex justify-content-center mt-3">
        <div class="me-5"><strong>💥 Intentos:</strong> <span id="intentos" class="badge bg-danger fs-5">5</span></div>
        <div><strong>⏱ Tiempo:</strong> <span id="tiempo" class="badge bg-warning text-dark fs-5">--</span></div>
    </div>
</div>

<div id="teclado" class="text-center mt-5">
    @foreach (var letra in "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ")
    {
        <button class="btn btn-secondary m-1 letra" onclick="intentarLetra('@letra')" id="btn-@letra">@letra</button>
    }
</div>

<div id="resultado" class="text-center mt-4 fs-4 fw-bold"></div>
<div id="mensajePalabraPerdida" class="text-center fs-4 fw-bold text-danger" style="display:none; margin-top: 20px;"></div>

@section Scripts {
    <script>
        const palabra = '@palabra'.toUpperCase();
        const sinTildes = palabra.normalize("NFD").replace(/[̀-ͯ]/g, "");
        let oculta = Array.from(sinTildes).map(l => l === ' ' ? ' ' : '_');
        let intentos = 5;
        let nivel = '@nivel';
        let tiempoRestante = nivel === 'Facil' ? 90 : nivel === 'Normal' ? 60 : 30;
        let duracion = 0;
        let partidaId = @partidaId;

        document.getElementById("palabra-oculta").innerText = oculta.join(" ");
        document.getElementById("tiempo").innerText = tiempoRestante + " segundos";

        const timer = setInterval(() => {
            tiempoRestante--;
            duracion++;
            document.getElementById("tiempo").innerText = tiempoRestante + " segundos";
            if (tiempoRestante <= 0) finalizarJuego(false);
        }, 1000);

        function intentarLetra(letra) {
            document.getElementById("btn-" + letra).disabled = true;
            let acierto = false;

            for (let i = 0; i < sinTildes.length; i++) {
                if (sinTildes[i] === letra) {
                    oculta[i] = palabra[i];
                    acierto = true;
                }
            }

            document.getElementById("palabra-oculta").innerText = oculta.join(" ");

            if (!acierto) {
                intentos--;
                document.getElementById("intentos").innerText = intentos;
            }

            if (intentos <= 0) finalizarJuego(false);
            if (!oculta.includes("_")) finalizarJuego(true);
        }

        function finalizarJuego(ganada) {
            clearInterval(timer);
            document.getElementById("teclado").style.display = "none";

            fetch('/Partidas/FinalizarPartida', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken\"]').val()
                },
                body: JSON.stringify({
                    id: partidaId,
                    ganada: ganada,
                    duracion: duracion
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (!ganada && data.palabra) {
                        document.getElementById("mensajePalabraPerdida").innerText = "La palabra era: " + data.palabra;
                        $('#mensajePalabraPerdida').fadeIn();

                        setTimeout(function () {
                            $('#mensajePalabraPerdida').fadeOut(function () {
                                window.location.href = '/Partidas/Escalafon';
                            });
                        }, 2000);
                    } else {
                        window.location.href = '/Partidas/Escalafon';
                    }
                }
            });

            document.getElementById("resultado").innerText = ganada ? "¡Ganaste!" : "Perdiste";
        }
    </script>
}
