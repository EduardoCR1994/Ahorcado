@model Ahorcado.Models.Partida
@{
    ViewBag.Title = "Partida - Jugar";
    var palabra = Model.Palabra.Texto.Normalize(System.Text.NormalizationForm.FormC);
    var jugador = Model.Jugador.Nombre;
    var jugadorId = Model.Jugador.Identificacion;
    var nivel = Model.Nivel;
    var partidaId = Model.PartidaID;
}

<!-- SweetAlert2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<h2 class="text-center mb-4"><i class="fas fa-gamepad"></i> Ahorcado - ¡Buena Suerte!</h2>

<div class="card text-center p-4">
    <p><strong>🎮 Jugador:</strong> @jugador</p>
    <p><strong>🎯 Nivel:</strong> @nivel</p>

    <h3 id="palabra-oculta" class="display-5 mt-4" style="letter-spacing: 12px;"></h3>

    <div class="d-flex justify-content-center mt-3">
        <div class="me-5"><strong>💥 Intentos:</strong> <span id="intentos" class="badge bg-danger fs-5">5</span></div>
        <div><strong>⏱ Tiempo:</strong> <span id="tiempo" class="badge bg-warning text-dark fs-5">--</span></div>
    </div>
</div>

<div id="teclado" class="text-center mt-5">
    @foreach (var letra in "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ")
    {
        <button class="btn btn-dark m-1 letra" onclick="intentarLetra('@letra')" id="btn-@letra">@letra</button>
    }
</div>

<div id="resultado" class="text-center mt-4 fs-4 fw-bold text-success"></div>
<div id="mensajePalabraPerdida" class="text-center fs-4 fw-bold text-danger" style="display:none; margin-top: 20px;"></div>

@section Scripts {
    <script>
        const palabra = '@Html.Raw(palabra)'.normalize("NFC").toUpperCase();
        const letras = Array.from(palabra);
        let oculta = letras.map(l => l === ' ' ? ' ' : '_');
        let intentos = 5;
        let nivel = '@nivel';
        let tiempoRestante = nivel === 'Fácil' ? 90 : nivel === 'Normal' ? 60 : 30;
        let duracion = 0;
        let partidaId = @partidaId;
        let jugadorId = '@jugadorId';

        document.getElementById("palabra-oculta").innerText = oculta.join(" ");
        document.getElementById("tiempo").innerText = tiempoRestante + " segundos";

        const timer = setInterval(() => {
            tiempoRestante--;
            duracion++;
            document.getElementById("tiempo").innerText = tiempoRestante + " segundos";
            if (tiempoRestante <= 0) finalizarJuego(false);
        }, 1000);

        function quitarTildes(letra) {
            return letra.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function intentarLetra(letra) {
            document.getElementById("btn-" + letra).disabled = true;
            let acierto = false;

            for (let i = 0; i < letras.length; i++) {
                if (quitarTildes(letras[i]) === letra) {
                    oculta[i] = letras[i];
                    acierto = true;
                }
            }

            document.getElementById("palabra-oculta").innerText = oculta.join(" ");

            if (!acierto) {
                intentos--;
                document.getElementById("intentos").innerText = intentos;
            }

            if (intentos <= 0) finalizarJuego(false);
            if (!oculta.includes("_")) finalizarJuego(true);
        }

        function finalizarJuego(ganada) {
            clearInterval(timer);
            document.getElementById("teclado").style.display = "none";

            fetch('/Partidas/FinalizarPartida', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken\"]').val()
                },
                body: JSON.stringify({
                    id: partidaId,
                    ganada: ganada,
                    duracion: duracion
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (ganada) {
                        Swal.fire({
                            title: '¡Ganaste! 🎉',
                            html: `
                                <p>¿Qué quieres hacer ahora?</p>
                                <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
                                    <button id="btnFacil" class="swal2-confirm swal2-styled">Fácil</button>
                                    <button id="btnNormal" class="swal2-confirm swal2-styled" style="background-color:#3085d6;">Normal</button>
                                    <button id="btnDificil" class="swal2-confirm swal2-styled" style="background-color:#d33;">Difícil</button>
                                    <button id="btnPersonalizar" class="swal2-confirm swal2-styled" style="background-color:#6c757d;">🔧 Personalizar</button>
                                    <button id="btnSalir" class="swal2-cancel swal2-styled" style="margin-top:5px;">Salir</button>
                                </div>
                            `,
                            showConfirmButton: false,
                            showCancelButton: false,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            didOpen: () => {
                                document.getElementById('btnFacil').addEventListener('click', () => {
                                    window.location.href = `/Partidas/Create?Nivel=Facil&JugadorID=${jugadorId}`;
                                });
                                document.getElementById('btnNormal').addEventListener('click', () => {
                                    window.location.href = `/Partidas/Create?Nivel=Normal&JugadorID=${jugadorId}`;
                                });
                                document.getElementById('btnDificil').addEventListener('click', () => {
                                    window.location.href = `/Partidas/Create?Nivel=Dificil&JugadorID=${jugadorId}`;
                                });
                                document.getElementById('btnPersonalizar').addEventListener('click', () => {
                                    window.location.href = `/Partidas/Create?JugadorID=${jugadorId}`;
                                });
                                document.getElementById('btnSalir').addEventListener('click', () => {
                                    window.location.href = '/Partidas/Escalafon';
                                });
                            }
                        });
                    } else if (data.palabra) {
                        document.getElementById("mensajePalabraPerdida").innerText = "La palabra era: " + data.palabra;
                        $('#mensajePalabraPerdida').fadeIn();
                        setTimeout(function () {
                            $('#mensajePalabraPerdida').fadeOut(function () {
                                window.location.href = '/Partidas/Escalafon';
                            });
                        }, 2000);
                    } else {
                        window.location.href = '/Partidas/Escalafon';
                    }
                }
            });

            document.getElementById("resultado").innerText = ganada ? "¡Ganaste!" : "Perdiste";
        }
    </script>
}
